<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema Experto de Hardware (JS puro)</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <header>
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <path d="M4 7a3 3 0 0 1 3-3h10a3 3 0 0 1 3 3v10a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V7Z" stroke="#64748b" stroke-width="1.5"/>
      <path d="M8 9h8M8 13h6M8 17h4" stroke="#94a3b8" stroke-width="1.5" stroke-linecap="round"/>
    </svg>
    <h1>Sistema experto para diagn√≥stico y mantenimiento de hardware</h1>
    <div class="header-right">
      <button type="button" id="btnToggleAuth" class="btn-small">Iniciar sesi√≥n</button>
    </div>
  </header>

  <main>
    <!-- Modal de Autenticaci√≥n -->
    <div id="authModal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="authTitle">Iniciar sesi√≥n</h2>
          <button type="button" class="close-btn" id="btnCloseAuth">&times;</button>
        </div>
        <form id="authForm">
          <input type="email" id="authEmail" placeholder="Email" required />
          <input type="password" id="authPassword" placeholder="Contrase√±a" required />
          <input type="text" id="authName" placeholder="Nombre completo" style="display:none" />
          <div id="authError" class="error" style="display:none"></div>
          <div class="modal-buttons">
            <button type="submit" id="btnAuthSubmit">Iniciar sesi√≥n</button>
          </div>
          <p id="toggleAuthMode" class="text-center muted" style="margin-top:12px;cursor:pointer">
            ¬øNo tienes cuenta? <span style="color:#3b82f6">Reg√≠strate aqu√≠</span>
          </p>
        </form>
      </div>
    </div>

    <!-- Panel de usuario/admin -->
    <div id="userPanel" class="user-panel hidden">
      <span id="userInfo"></span>
      <button type="button" id="btnLogout" class="btn-small-ghost">Cerrar sesi√≥n</button>
    </div>

    <!-- Panel de Admin -->
    <div id="adminPanel" class="card hidden" style="margin: 24px; margin-bottom: 0;">
      <div class="body">
        <h2>üîß Panel de Administrador</h2>
        <p class="sub">Crear y gestionar reglas diagn√≥sticas</p>
        <form id="adminRuleForm">
          <input type="text" id="adminRuleId" placeholder="ID de Regla (ej: F19)" required />
          <textarea id="adminRuleFault" placeholder="Falla/Diagn√≥stico" required></textarea>
          <input type="number" id="adminRuleWeight" placeholder="Peso (0-1)" min="0" max="1" step="0.1" value="0.7" />
          <input type="text" id="adminRuleConditions" placeholder="Condiciones (separadas por comas)" />
          <textarea id="adminRuleAdvice" placeholder="Recomendaciones (una por l√≠nea)"></textarea>
          <div id="adminError" class="error" style="display:none"></div>
          <button type="submit">Crear Regla</button>
        </form>
      </div>
    </div>

    <div id="mainContent">
  </main>

  <script>
  /* ===============================
     Frontend ‚Äì Sistema Experto (JS)
     Con soporte para Auth y Admin
     =============================== */

  // Detecta si es producci√≥n o desarrollo
  const API_BASE = window.location.hostname === 'localhost' 
    ? "http://localhost:4000"
    : "https://diagnostic-api.onrender.com";
  let currentUser = null;
  let authMode = 'login'; // 'login' o 'register'

  // 1) Cat√°logo de s√≠ntomas
  const SYMPTOMS = [
    { id:"no_power", label:"El equipo NO enciende (sin luces)" },
    { id:"power_cable_ok", label:"Cable de energ√≠a y toma est√°n OK" },
    { id:"power_cable_bad", label:"Cable/toma con fallas (holgura/chispas)" },
    { id:"burn_smell", label:"Olor/se√±al de quemado" },
    { id:"no_burn_smell", label:"No hay olor a quemado" },
    { id:"power_button_ok", label:"Bot√≥n de encendido hace buen contacto" },
    { id:"power_button_bad", label:"Bot√≥n de encendido atascado / cableado suelto" },
    { id:"fans_spin_no_image", label:"Ventiladores funcionan pero NO hay imagen" },
    { id:"monitor_has_signal", label:"El monitor enciende y muestra 'sin se√±al'" },
    { id:"monitor_no_signal", label:"Monitor sin retroiluminaci√≥n/se√±al" },
    { id:"video_cable_ok", label:"Cable de video conectado y monitor encendido" },
    { id:"video_cable_bad", label:"Cable de video defectuoso / mala conexi√≥n" },
    { id:"beeps_present", label:"Emite pitidos al arrancar" },
    { id:"no_beeps", label:"NO emite pitidos" },
    { id:"beeps_1l2s", label:"Patr√≥n beeps: 1 largo, 2 cortos" },
    { id:"beeps_continuous", label:"Pitidos continuos" },
    { id:"beeps_other", label:"C√≥digo de beeps distinto" },
    { id:"shows_image_no_boot", label:"Se muestra imagen pero NO inicia el SO" },
    { id:"bios_accessible", label:"Puedo ingresar a la BIOS" },
    { id:"bios_inaccessible", label:"NO puedo ingresar a la BIOS" },
    { id:"disk_detected", label:"Disco detectado en BIOS" },
    { id:"disk_not_detected", label:"Disco NO detectado en BIOS" },
    { id:"boot_error", label:"Mensaje de 'No boot' / 'Boot error'" },
    { id:"bsod_or_restarts", label:"BSOD o reinicio tras iniciar" },
    { id:"os_corrupt_signs", label:"Signos de SO/servicios cr√≠ticos corruptos" },
    { id:"very_slow", label:"El equipo inicia pero est√° MUY lento" },
    { id:"smart_errors", label:"Errores SMART o disco al 100% sostenido" },
    { id:"random_restart", label:"Se reinicia solo / se apaga sin aviso" },
    { id:"overheat", label:"Sobrecalentamiento (temperaturas altas)" },
    { id:"no_overheat", label:"NO hay signos de sobrecalentamiento" },
    { id:"peripherals_ok", label:"Perif√©ricos funcionan correctamente" },
    { id:"peripherals_fail", label:"Perif√©ricos con fallas (teclado/mouse/USB)" },
    { id:"peripherals_detected_bios", label:"Perif√©ricos se detectan en BIOS" },
    { id:"peripherals_not_detected_bios", label:"Perif√©ricos NO se detectan en BIOS" },
    { id:"image_flicker", label:"Imagen con parpadeos/l√≠neas" },
    { id:"sound_ok", label:"Sonido OK" },
    { id:"sound_fail", label:"Sonido NO funciona" },
    { id:"net_card_not_detected", label:"No detecta la tarjeta de red" },
    { id:"net_detects_no_connect", label:"Detecta tarjeta pero NO conecta" },
    { id:"network_ok", label:"Red y Wi-Fi funcionan correctamente" }
  ];

  let KB = [];

  // 2) Motor de inferencia
  function diagnose(selected) {
    if (!KB.length) {
      document.getElementById('results').innerHTML =
        `<div class="muted">‚ö†Ô∏è No hay reglas cargadas. Revisa /api/rules o vuelve a cargar la p√°gina.</div>`;
      return [];
    }
    return KB.map(rule => {
      const total = rule.if.length || 1;
      const hit = rule.if.filter(x => selected.has(x)).length;
      const score = (hit / total) * (rule.weight ?? 0.7);
      return { id: rule.id, fault: rule.then.fault, advice: rule.then.advice || [], matched: hit, total, weight: rule.weight ?? 0.7, score };
    })
    .filter(r => r.score > 0.15)
    .sort((a,b) => b.score - a.score);
  }

  // 3) Render UI
  const $mainContent = document.getElementById('mainContent');
  const $results  = document.getElementById('results');
  const $kbPre    = document.getElementById('kbPre');
  const $modal    = document.getElementById('authModal');
  const $userPanel = document.getElementById('userPanel');
  const $adminPanel = document.getElementById('adminPanel');

  function renderMainContent() {
    if (!currentUser) return;
    
    $mainContent.innerHTML = `
      <div class="body">
        <h2>1) Selecciona los s√≠ntomas observados</h2>
        <p class="sub">Marca todo lo que aplique. Luego haz clic en <b>Diagnosticar</b>.</p>
        <form id="symForm">
          <fieldset id="symptoms"></fieldset>
          <div class="toolbar">
            <button type="button" id="btnDiagnose">Diagnosticar</button>
            <button type="button" class="secondary" id="btnLimpiar">Limpiar</button>
            <button type="button" class="ghost" id="btnExport">Exportar caso</button>
          </div>
        </form>
      </div>
    `;

    const resultsCard = `
      <section class="card">
        <div class="body">
          <h2>2) Resultados</h2>
          <p class="sub">El motor de inferencia pondera reglas por coincidencia y certeza. Explicaciones incluidas.</p>
          <div id="results" class="result">
            <div class="muted">Sin diagn√≥stico a√∫n.</div>
          </div>
        </div>
      </section>
    `;

    const kbCard = `
      <section class="card" style="grid-column: 1 / -1;">
        <div class="body">
          <h2>Base de conocimientos</h2>
          <p class="sub">Reglas declarativas en JSON.</p>
          <details>
            <summary>Ver/ocultar reglas</summary>
            <pre id="kbPre" class="muted" style="white-space:pre-wrap"></pre>
          </details>
          <h2 style="margin-top:20px">Notas</h2>
          <div class="kv">
            <div class="muted">Estrategia</div>
            <div>Encadenamiento <b>hacia adelante</b> (data-driven) con coincidencia parcial y factores de certeza.</div>
            <div class="muted">Explicaciones</div>
            <div>Se listan condiciones que activaron cada hip√≥tesis y recomendaciones de mantenimiento.</div>
            <div class="muted">Persistencia</div>
            <div>Exporta cada caso en JSON para retroalimentaci√≥n futura.</div>
          </div>
        </div>
        <div class="footer">¬© Proyecto acad√©mico ‚Äì UMB. Motor y UI en JavaScript sin librer√≠as.</div>
      </section>
    `;

    document.querySelector('main').innerHTML = 
      ($adminPanel.classList.contains('hidden') ? '' : $adminPanel.outerHTML) +
      resultsCard +
      kbCard;

    renderSymptoms();
    setupEventListeners();
  }

  function renderSymptoms() {
    const $symptoms = document.getElementById('symptoms');
    if (!$symptoms) return;
    
    $symptoms.innerHTML = '';
    SYMPTOMS.forEach(s => {
      const el = document.createElement('label');
      el.className = 'sym';
      el.innerHTML = `<input type="checkbox" data-sym="${s.id}"/> <span>${s.label}</span>`;
      $symptoms.appendChild(el);
    });
  }

  function getSelected() {
    const set = new Set();
    document.querySelectorAll('input[type="checkbox"][data-sym]').forEach(b => {
      if (b.checked) set.add(b.dataset.sym);
    });
    return set;
  }

  function renderResults(list, selected) {
    const $results = document.getElementById('results');
    if (!$results) return;
    
    if (!list.length) {
      $results.innerHTML = `<div class="muted">No hay hip√≥tesis suficientes con los hechos actuales.</div>`;
      return;
    }
    $results.innerHTML = '';
    list.forEach((r,i) => {
      const percent = Math.round(r.score * 100);
      const item = document.createElement('div');
      item.className = 'item';
      const explainConds = (KB.find(k=>k.id===r.id)?.if||[]).map(id => ({
        label: SYMPTOMS.find(s=>s.id===id)?.label || id,
        ok: selected.has(id)
      }));
      item.innerHTML = `
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3>${i+1}. ${r.fault}</h3>
          <span class="badge">Score: ${percent}%</span>
        </div>
        <div class="bar"><div class="fill" style="width:${percent}%"></div></div>
        <div class="explain">Coincidencias: ${r.matched}/${r.total} ¬∑ Peso: ${Math.round(r.weight*100)}%</div>
        <ul class="explain">${explainConds.map(c=>`<li>${c.ok ? "‚úÖ" : "‚ñ´Ô∏è"} ${c.label}</li>`).join('')}</ul>
        <div class="muted" style="margin:6px 0 4px">Recomendaciones:</div>
        <ul>${(r.advice||[]).map(a=>`<li>${a}</li>`).join('')}</ul>
      `;
      $results.appendChild(item);
    });
  }

  function setupEventListeners() {
    const $btnDiagnose = document.getElementById('btnDiagnose');
    const $btnLimpiar = document.getElementById('btnLimpiar');
    const $btnExport = document.getElementById('btnExport');

    if ($btnDiagnose) {
      $btnDiagnose.addEventListener('click', () => {
        const sel = getSelected();
        const res = diagnose(sel);
        renderResults(res, sel);
        saveCaseToAPI(sel, res);
      });
    }

    if ($btnLimpiar) {
      $btnLimpiar.addEventListener('click', () => {
        document.querySelectorAll('input[type="checkbox"][data-sym]').forEach(b => b.checked = false);
        const $results = document.getElementById('results');
        if ($results) $results.innerHTML = '<div class="muted">Sin diagn√≥stico a√∫n.</div>';
      });
    }

    if ($btnExport) {
      $btnExport.addEventListener('click', () => {
        const sel = getSelected();
        const res = diagnose(sel);
        const payload = { timestamp: new Date().toISOString(), selected: Array.from(sel), results: res };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `caso_dx_${Date.now()}.json`;
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      });
    }
  }

  // 4) API calls
  async function loadRulesFromAPI() {
    try {
      if ($kbPre) $kbPre.textContent = "Cargando reglas‚Ä¶";
      const res = await fetch(`${API_BASE}/api/rules?t=${Date.now()}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const rulesFromDb = await res.json();
      KB = rulesFromDb.map(r => ({
        id: r.ruleId,
        if: r.conditions || [],
        weight: r.weight ?? 0.7,
        then: { fault: r.fault, advice: r.advice || [] }
      }));
      if ($kbPre) $kbPre.textContent = JSON.stringify(KB, null, 2);
      console.log("KB cargada:", KB.length);
    } catch (e) {
      if ($kbPre) $kbPre.textContent = `No se pudieron cargar las reglas: ${e.message}`;
    }
  }

  async function saveCaseToAPI(selected, results) {
    if (!currentUser) return;
    try {
      const payload = {
        timestamp: new Date().toISOString(),
        selected: Array.from(selected),
        results: results.map(r => ({
          ruleId: r.id,
          score: r.score,
          matched: r.matched,
          total: r.total,
          weight: r.weight
        }))
      };
      const res = await fetch(`${API_BASE}/api/cases`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      console.log("Caso guardado.");
    } catch (e) {
      console.error("No se pudo guardar el caso:", e);
    }
  }

  // 5) Auth functions
  async function login(email, password) {
    try {
      const res = await fetch(`${API_BASE}/api/auth/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ email, password })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Error al iniciar sesi√≥n");
      
      currentUser = data.user;
      localStorage.setItem('user', JSON.stringify(currentUser));
      updateUI();
      $modal.classList.add('hidden');
      renderMainContent();
      loadRulesFromAPI();
    } catch (e) {
      showAuthError(e.message);
    }
  }

  async function register(email, name, password) {
    try {
      const res = await fetch(`${API_BASE}/api/auth/register`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ email, name, password })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Error al registrarse");
      
      currentUser = data.user;
      localStorage.setItem('user', JSON.stringify(currentUser));
      updateUI();
      $modal.classList.add('hidden');
      renderMainContent();
      loadRulesFromAPI();
    } catch (e) {
      showAuthError(e.message);
    }
  }

  async function logout() {
    try {
      await fetch(`${API_BASE}/api/auth/logout`, {
        method: "POST",
        credentials: "include"
      });
      currentUser = null;
      localStorage.removeItem('user');
      updateUI();
      $modal.classList.remove('hidden');
    } catch (e) {
      console.error("Error al cerrar sesi√≥n:", e);
    }
  }

  function updateUI() {
    if (currentUser) {
      $userPanel.classList.remove('hidden');
      document.getElementById('userInfo').textContent = `${currentUser.name || currentUser.email}${currentUser.role === 'admin' ? ' (üë®‚Äçüíº Admin)' : ''}`;
      document.getElementById('btnToggleAuth').style.display = 'none';
      
      if (currentUser.role === 'admin') {
        $adminPanel.classList.remove('hidden');
      } else {
        $adminPanel.classList.add('hidden');
      }
    } else {
      $userPanel.classList.add('hidden');
      document.getElementById('btnToggleAuth').style.display = 'block';
      $adminPanel.classList.add('hidden');
    }
  }

  function showAuthError(msg) {
    const $err = document.getElementById('authError');
    if ($err) {
      $err.textContent = msg;
      $err.style.display = 'block';
    }
  }

  // 6) Admin functions
  async function createRule(ruleId, conditions, weight, fault, advice) {
    if (!currentUser || currentUser.role !== 'admin') {
      showAdminError("No autorizado");
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/api/admin/rules`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({
          ruleId,
          conditions: conditions.split(',').map(s => s.trim()).filter(Boolean),
          weight: parseFloat(weight) || 0.7,
          fault,
          advice: advice.split('\n').map(s => s.trim()).filter(Boolean)
        })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Error al crear regla");
      
      alert("‚úÖ Regla creada correctamente");
      document.getElementById('adminRuleForm').reset();
      loadRulesFromAPI();
      renderResults(diagnose(getSelected()), getSelected());
    } catch (e) {
      showAdminError(e.message);
    }
  }

  function showAdminError(msg) {
    const $err = document.getElementById('adminError');
    if ($err) {
      $err.textContent = msg;
      $err.style.display = 'block';
      setTimeout(() => { $err.style.display = 'none'; }, 5000);
    }
  }

  // 7) Event listeners
  document.getElementById('btnToggleAuth').addEventListener('click', () => {
    authMode = 'login';
    document.getElementById('authTitle').textContent = 'Iniciar sesi√≥n';
    document.getElementById('authName').style.display = 'none';
    document.getElementById('authPassword').value = '';
    document.getElementById('authEmail').value = '';
    document.getElementById('authError').style.display = 'none';
    $modal.classList.remove('hidden');
  });

  document.getElementById('btnCloseAuth').addEventListener('click', () => {
    $modal.classList.add('hidden');
  });

  document.getElementById('toggleAuthMode').addEventListener('click', () => {
    authMode = authMode === 'login' ? 'register' : 'login';
    document.getElementById('authTitle').textContent = authMode === 'login' ? 'Iniciar sesi√≥n' : 'Crear cuenta';
    document.getElementById('authName').style.display = authMode === 'register' ? 'block' : 'none';
    document.getElementById('authError').style.display = 'none';
  });

  document.getElementById('authForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const email = document.getElementById('authEmail').value;
    const password = document.getElementById('authPassword').value;
    
    if (authMode === 'login') {
      login(email, password);
    } else {
      const name = document.getElementById('authName').value;
      register(email, name, password);
    }
  });

  document.getElementById('btnLogout').addEventListener('click', logout);

  document.getElementById('adminRuleForm').addEventListener('submit', (e) => {
    e.preventDefault();
    createRule(
      document.getElementById('adminRuleId').value,
      document.getElementById('adminRuleConditions').value,
      document.getElementById('adminRuleWeight').value,
      document.getElementById('adminRuleFault').value,
      document.getElementById('adminRuleAdvice').value
    );
  });

  // 8) Init
  const saved = localStorage.getItem('user');
  if (saved) {
    try {
      currentUser = JSON.parse(saved);
      updateUI();
      renderMainContent();
      loadRulesFromAPI();
    } catch (e) {
      console.error("Error al cargar usuario:", e);
      currentUser = null;
    }
  }

  if (!currentUser) {
    $modal.classList.remove('hidden');
  }
  </script>
</body>
</html>
